<!DOCTYPE html><html lang="null"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="专注Java后端"><title>统一的数据访问异常体系 | Java工匠</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">统一的数据访问异常体系</h1><a id="logo" href="/.">Java工匠</a><p class="description">编码让世界变得更美好</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Start</i></a><a href="/archives/"><i class="fa fa-archive"> Archiv</i></a><a href="/about/about.html"><i class="fa fa-user"> Über</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">统一的数据访问异常体系</h1><div class="post-meta">Jun 1, 2018<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="post-content"><p>Spring提供的统一数据访问异常体系分两部分：</p>
<ol>
<li>细化SQLException分类：构建了一套语义明确以DataAccessException为基础的数据访问异常体系；</li>
<li>异常转换：抛出的数据访问异常转换为DataAccessException，纳入数据访问异常体系内；</li>
</ol>
<h3 id="一-细化SQLException分类"><a href="#一-细化SQLException分类" class="headerlink" title="一.细化SQLException分类"></a>一.细化SQLException分类</h3><p>Spring数据访问异常体系是unchecked exception类型，出发点是一般我们是正常执行SQL的，在遇到异常时其实我们能做的事情有限：捕捉异常，打印日志，终止线程运行。使用unchecked exception类型的好处是接口比较稳定，不受具体的数据访问机制影响。Spring数据访问异常体系部分类图如下：</p>
<p><a href="../../../../picture/2018/06/01/Exception-DataAccessException-class.png?_blank">查看大图</a></p>
<p><img src="../../../../picture/2018/06/01/Exception-DataAccessException-class.png" alt="DataAccessException类图"></p>
<h3 id="二-异常转换"><a href="#二-异常转换" class="headerlink" title="二.异常转换"></a>二.异常转换</h3><p>异常的转换也分两部分来讲：</p>
<ol>
<li>JDBC异常转换：因SQLException返回的ErrorCode和SQLState在不同数据库厂商之间并未统一，就需要对不同厂商单独解析转换为对应DataAccessException；</li>
<li>其他持久化技术异常转换支持：如Hibernate数据访问异常体系转义到Spring异常体系；</li>
</ol>
<h4 id="1-JDBC异常转换"><a href="#1-JDBC异常转换" class="headerlink" title="1.JDBC异常转换"></a>1.JDBC异常转换</h4><p>JDBC异常转换时主要通过SQLExceptionTranslator子类来实现，我们先看下SQLExceptionTranslator类图：</p>
<p><a href="../../../../picture/2018/06/01/Exception-SQLExceptionTranslator-class.png?_blank">查看大图</a></p>
<p><img src="../../../../picture/2018/06/01/Exception-SQLExceptionTranslator-class.png" alt="SQLExceptionTranslator类图"></p>
<p>通过上图大家有没有发现三个实现类之间的关系—组合关系，组合关系在父类AbstractFallbackSQLExceptionTranslator中变成了递归调用，这里充满了智慧(Composite设计模式)。</p>
<p>下图是AbstractFallbackSQLExceptionTranslator部分源代码：</p>
<p><a href="../../../../picture/2018/06/01/Wisdom-AbstractFallbackSQLExceptionTranslator_translate.jpg?_blank">查看大图</a></p>
<p><img src="../../../../picture/2018/06/01/Wisdom-AbstractFallbackSQLExceptionTranslator_translate.jpg" alt="AbstractFallbackSQLExceptionTranslator_translate源码"></p>
<p>下面我们认识一个工具类SQLErrorCodesFactory，它在异常转换中发挥着重要作用。在sql-error-codes.xml中通过Bean方式，定义了不同数据库厂商的错误类型与ErrorCode的关系。在SQLErrorCodesFactory（单例模式）实例化时，通过容器获取这些Bean，并维护到自身Map变量中，为SQLErrorCodeSQLExceptionTranslator使用做准备。</p>
<p>下图是-sql-error-codes.xml部分源代码：</p>
<p><a href="../../../../picture/2018/06/01/Wisdom-sql-error-codes-xml.jpg?_blank">查看大图</a></p>
<p><img src="../../../../picture/2018/06/01/Wisdom-sql-error-codes-xml.jpg" alt="sql-error-codes-xml部分源码"></p>
<p>下图是SQLErrorCodesFactory部分源代码：<br><a href="../../../../picture/2018/06/01/Wisdom-SQLErrorCodesFactory-init.jpg?_blank">查看大图</a></p>
<p><img src="../../../../picture/2018/06/01/Wisdom-SQLErrorCodesFactory-init.jpg" alt="SQLErrorCodesFactory初始化源码"></p>
<p>下面我们通过具体子类SQLErrorCodeSQLExceptionTranslator具体是如何转换的，时序图如下：</p>
<p><a href="../../../../picture/2018/06/01/Exception-SQLErrorCodeSQLExceptionTranslator_doTranslate-sequence.png?_blank">查看大图</a></p>
<p><img src="../../../../picture/2018/06/01/Exception-SQLErrorCodeSQLExceptionTranslator_doTranslate-sequence.png" alt="SQLErrorCodeSQLExceptionTranslator异常转换时序图"></p>
<p>下图是SqlErrorCodeSQLExceptionTranslator部分源代码：</p>
<p><a href="../../../../picture/2018/06/01/Wisdom-SqlErrorCodeSQLExceptionTranslator_doTranslate.jpg?_blank">查看大图</a></p>
<p><img src="../../../../picture/2018/06/01/Wisdom-SqlErrorCodeSQLExceptionTranslator_doTranslate.jpg" alt="SqlErrorCodeSQLExceptionTranslator部分源代码"></p>
<h4 id="2-其他持久化技术异常转换支持"><a href="#2-其他持久化技术异常转换支持" class="headerlink" title="2. 其他持久化技术异常转换支持"></a>2. 其他持久化技术异常转换支持</h4><p>由于各种ORM持久化技术都有一个语义明确的异常体系，所以Spring也需要考虑到这部分的异常转换。下图是对Hibernate的支持，其他ORM持久化技术也有类似支持工具类。</p>
<p>下图是SessionFactoryUtils部分源代码：</p>
<p><a href="../../../../picture/2018/06/01/SessionFactoryUtils_convertHibernateAccessException.jpg?_blank">查看大图</a></p>
<p><img src="../../../../picture/2018/06/01/SessionFactoryUtils_convertHibernateAccessException.jpg" alt="SessionFactoryUtils_convertHibernateAccessException部分源码"></p>
<p>以上就是Spring提供给我们统一的异常体系，是不是亮点很多，大家以后开发中可以借鉴里面的思路。整体感受，规范的重要性。现在数据库事务和异常都讲了，接下来我们看另一个话题：缓存。看看Spring是如何实现缓存框架，也是先从<a href="../../../06/02/Spring缓存基础设施介绍">Spring缓存基础设施介绍</a>开始。</p>
<p>备注：</p>
<ol>
<li>Composite设计模式：组合模式，简单理解为能组合后能递归调用的程序结构即可，一般书中用文件与文件夹来做比喻。</li>
<li>Singleton设计模式：单例模式，只允许生成一个实例。</li>
</ol>
<p>快速导航：</p>
<ul>
<li><a href="../../../06/06/Spring源码学习笔记汇总">Spring源码学习笔记汇总</a></li>
</ul>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://yoursite.com/2018/06/01/统一的数据访问异常体系/" data-id="cji2kyh8u001nrhuyg9van2q4" class="article-share-link">Aktie</a><div class="tags"><a href="/tags/Spring/">Spring</a></div><div class="post-nav"><a href="/2018/06/02/Spring缓存基础设施介绍/" class="pre">Spring缓存基础设施介绍</a><a href="/2018/05/31/Spring事务管理原理/" class="next">Spring事务管理原理</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Kategorien</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/基础设施/" style="font-size: 15px;">基础设施</a> <a href="/tags/活动/" style="font-size: 15px;">活动</a> <a href="/tags/maven/" style="font-size: 15px;">maven</a> <a href="/tags/缓存/" style="font-size: 15px;">缓存</a> <a href="/tags/Spring/" style="font-size: 15px;">Spring</a> <a href="/tags/读书/" style="font-size: 15px;">读书</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Letzte</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/06/06/Spring源码学习笔记汇总/">Spring源码学习笔记汇总</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/06/Spring源码学习总结/">Spring源码学习总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/05/视图处理/">视图处理</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/04/通过Handler处理业务请求/">通过Handler处理业务请求</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/03/查找处理请求的Handler/">查找处理请求的Handler</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/03/Spring-MVC心脏-DispactcherServlet/">Spring-MVC心脏-DispactcherServlet</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/03/Spring-MVC基础设施介绍/">Spring-MVC基础设施介绍</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/02/Spring缓存管理原理/">Spring缓存管理原理</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/02/Spring缓存基础设施介绍/">Spring缓存基础设施介绍</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/01/统一的数据访问异常体系/">统一的数据访问异常体系</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Blogroll</i></div><ul></ul><a href="http://goldymark.coding.me/" title="GoldyMark" target="_blank">GoldyMark</a><ul></ul><a href="http://www.bjdp.org/" title="BJDP" target="_blank">BJDP</a><ul></ul><a href="http://tech.meituan.com/" title="美团点评技术团队博客" target="_blank">美团点评技术团队博客</a><ul></ul><a href="http://www.ibm.com/developerworks/cn/" title="IBM技术博客" target="_blank">IBM技术博客</a><ul></ul><a href="http://insights.thoughtworkers.org/" title="ThoughtWorks洞见" target="_blank">ThoughtWorks洞见</a><ul></ul><a href="http://ifeve.com/" title="并发编程网" target="_blank">并发编程网</a><ul></ul><a href="http://www.infoq.com/cn" title="InfoQ" target="_blank">InfoQ</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">Java工匠.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>